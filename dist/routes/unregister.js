"use strict";var _express=require("express");var _passport=require("passport");var _passport2=_interopRequireDefault(_passport);var _UserModel=require("../models/UserModel");var _geoipLite=require("geoip-lite");var _geoipLite2=_interopRequireDefault(_geoipLite);var _path=require("path");var _path2=_interopRequireDefault(_path);var _fs=require("fs");var _fs2=_interopRequireDefault(_fs);var _cipher=require("../utils/cipher");var _logger=require("../utils/logger");var _email=require("../utils/email");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var router=(0,_express.Router)();router.get("/",function(req,res){if(!req.session.error)req.session.error=[];var language=req.acceptsLanguages("es","en");if(!language)language="en";if(req.user)res.redirect("/home");else{var assets=JSON.parse(_fs2.default.readFileSync(_path2.default.join(__dirname,"../assets/"+language+".json"),"utf-8"));res.render("index",{title:"Cyclon - "+assets.titles.index,assets:assets,path:"/",errors:req.session.error})}});router.get("/privacy",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";var assets=JSON.parse(_fs2.default.readFileSync(_path2.default.join(__dirname,"../assets/"+language+".json"),"utf-8"));res.render("privacy",{title:"Cyclon - "+assets.titles.privacy,path:"/privacy",assets:assets})});router.get("/terms",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";var assets=JSON.parse(_fs2.default.readFileSync(_path2.default.join(__dirname,"../assets/"+language+".json"),"utf-8"));res.render("terms",{title:"Cyclon - "+assets.titles.terms,path:"/terms",assets:assets})});router.get("/assets",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";res.send(JSON.parse(_fs2.default.readFileSync(_path2.default.join(__dirname,"../assets/"+language+".json"),"utf-8")))});router.get("/auth/facebook",_passport2.default.authenticate("facebook-auth",{authType:"rerequest",scope:["email"]}));router.get("/auth/facebook/callback",function(req,res,next){_passport2.default.authenticate("facebook-auth",function(err,user,info){if(err){req.session.error=err;return res.redirect("/?action=login")}if(!user){req.session.error=["BAD_INPUT"];return res.redirect("/?action=login")}req.logIn(user,function(err){if(err)return next({code:401,msg:err});req.session.error=[];return res.redirect("/home")})})(req,res,next)});router.get("/auth/google",_passport2.default.authenticate("google-auth",{scope:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"]}));router.get("/auth/google/callback",function(req,res,next){_passport2.default.authenticate("google-auth",function(err,user,info){if(err){req.session.error=err;return res.redirect("/?action=login")}if(!user){req.session.error=["BAD_INPUT"];return res.redirect("/?action=login")}req.logIn(user,function(err){if(err)return next({code:401,msg:err});req.session.error=[];return res.redirect("/home")})})(req,res,next)});router.post("/auth/mobile/facebook",function(req,res){_UserModel.UserModel.find({email:(0,_cipher.encryptAES)((0,_cipher.decryptAndroid)(req.body.email))},function(err,docs){if(err)_logger.errorLog.error(err);if(docs.length==0){var newUser=new _UserModel.UserModel;var geo=_geoipLite2.default.lookup(req.ip);if(geo){var userObject=newUser.encryptUser((0,_cipher.decryptAndroid)(req.body.email),geo.ll[0],geo.ll[1],(0,_cipher.decryptAndroid)(req.body.id));newUser.name=(0,_cipher.decryptAndroid)(req.body.name);newUser.lastName=(0,_cipher.decryptAndroid)(req.body.lastName);newUser.email=userObject.email;newUser.location.lat=userObject.lat;newUser.location.lng=userObject.lng;newUser.password=userObject.password;newUser.type=0;newUser.verify=true;newUser.save();res.json({code:200,msg:"LOGIN_SUCCESS"})}else res.json({code:401,msg:"BAD_LOCATION"})}else res.json({code:200,msg:"LOGIN_SUCCESS"})})});router.post("/auth/mobile/google",function(req,res){_UserModel.UserModel.find({email:(0,_cipher.encryptAES)((0,_cipher.decryptAndroid)(req.body.email))},function(err,docs){if(err)_logger.errorLog.error(err);if(docs.length==0){var newUser=new _UserModel.UserModel;var geo=_geoipLite2.default.lookup(req.ip);if(geo){var userObject=newUser.encryptUser((0,_cipher.decryptAndroid)(req.body.email),geo.ll[0],geo.ll[1],(0,_cipher.decryptAndroid)(req.body.id));newUser.name=(0,_cipher.decryptAndroid)(req.body.givenName);newUser.lastName=(0,_cipher.decryptAndroid)(req.body.familyName);newUser.email=userObject.email;newUser.location.lat=userObject.lat;newUser.location.lng=userObject.lng;newUser.password=userObject.password;newUser.type=0;newUser.verify=true;newUser.save();res.json({code:200,msg:["ACCOUNT_CREATED"]})}else res.json({code:401,msg:["BAD_LOCATION"]})}else res.json({code:200,msg:["LOGIN_SUCCESS"]})})});router.post("/auth/register",function(req,res,next){var language=req.acceptsLanguages("es","en");if(!language)language="en";_passport2.default.authenticate("local-signup",function(err,user,info){if(err)return res.json({code:401,msg:err});if(!user)return res.json({code:401,msg:["BAD_INPUT"]});(0,_email.sendEmail)((0,_cipher.decryptAES)(user.email),"verification",language,user.name+" "+user.lastName,user.type,user.email);req.logIn(user,function(err){if(err)return next(err);return res.json({code:200,msg:"SIGNUP_SUCCESS"})})})(req,res,next)});router.post("/auth/login",function(req,res,next){_passport2.default.authenticate("local-signin",function(err,user,info){if(err)return res.send({code:401,msg:err});if(!user)return res.json({code:401,msg:["BAD_INPUT"]});req.logIn(user,function(err){if(err)return next({code:401,msg:err});res.cookie("auth",(0,_cipher.encryptAES)(JSON.stringify(user)));return res.json({code:200,msg:["LOGIN_SUCCESS"]})})})(req,res,next)});router.get("/logout",function(req,res){req.session.destroy();req.logout();res.clearCookie("auth");res.redirect("/")});module.exports=router;
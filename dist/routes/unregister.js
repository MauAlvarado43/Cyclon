"use strict";var _express=require("express");var _passport=_interopRequireDefault(require("passport"));var _UserModel=require("../models/UserModel");var _geoipLite=_interopRequireDefault(require("geoip-lite"));var _path=_interopRequireDefault(require("path"));var _fs=_interopRequireDefault(require("fs"));var _cipher=require("../utils/cipher");var _logger=require("../utils/logger");var _email=require("../utils/email");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var router=(0,_express.Router)();router.get("/",function(req,res){if(!req.session.error)req.session.error=[];var language=req.acceptsLanguages("es","en");if(!language)language="en";if(req.user)res.redirect("/home");else{var assets=JSON.parse(_fs["default"].readFileSync(_path["default"].join(__dirname,"../assets/"+language+".json"),"utf-8"));res.render("index",{title:"Cyclon - ".concat(assets.titles.index),assets:assets,path:"/",errors:req.session.error?req.session.error:[]})}});router.get("/privacy",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";var assets=JSON.parse(_fs["default"].readFileSync(_path["default"].join(__dirname,"../assets/"+language+".json"),"utf-8"));res.render("privacy",{title:"Cyclon - ".concat(assets.titles.privacy),path:"/privacy",assets:assets})});router.get("/terms",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";var assets=JSON.parse(_fs["default"].readFileSync(_path["default"].join(__dirname,"../assets/"+language+".json"),"utf-8"));res.render("terms",{title:"Cyclon - ".concat(assets.titles.terms),path:"/terms",assets:assets})});router.get("/assets",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";res.send(JSON.parse(_fs["default"].readFileSync(_path["default"].join(__dirname,"../assets/"+language+".json"),"utf-8")))});router.get("/auth/facebook",_passport["default"].authenticate("facebook-auth",{authType:"rerequest",scope:["email"]}));router.get("/auth/facebook/callback",function(req,res,next){_passport["default"].authenticate("facebook-auth",function(err,user,info){if(err){req.session.error=err;return res.redirect("/?action=login")}if(!user){req.session.error=["BAD_INPUT"];return res.redirect("/?action=login")}req.logIn(user,function(err){if(err)return next({code:401,msg:err});req.session.error=[];req.session.type=user.type;return res.redirect("/home")})})(req,res,next)});router.get("/auth/google",_passport["default"].authenticate("google-auth",{scope:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"]}));router.get("/auth/google/callback",function(req,res,next){_passport["default"].authenticate("google-auth",function(err,user,info){if(err){req.session.error=err;return res.redirect("/?action=login")}if(!user){req.session.error=["BAD_INPUT"];return res.redirect("/?action=login")}req.logIn(user,function(err){if(err)return next({code:401,msg:err});req.session.error=[];req.session.type=user.type;return res.redirect("/home")})})(req,res,next)});router.post("/auth/mobile/facebook",function(req,res){_UserModel.UserModel.find({email:(0,_cipher.encryptAES)((0,_cipher.decryptAndroid)(req.body.email))},function(err,docs){if(err)_logger.errorLog.error(err);if(docs.length==0){var newUser=new _UserModel.UserModel;var geo=[(0,_cipher.decryptAndroid)(req.body.lat),(0,_cipher.decryptAndroid)(req.body.lng)];if(geo){var userObject=newUser.encryptUser((0,_cipher.decryptAndroid)(req.body.email),geo[0],geo[1],(0,_cipher.decryptAndroid)(req.body.id));newUser.name=(0,_cipher.decryptAndroid)(req.body.name);newUser.lastName=(0,_cipher.decryptAndroid)(req.body.last_name);newUser.email=userObject.email;newUser.location.lat=userObject.lat;newUser.location.lng=userObject.lng;newUser.password=userObject.password;newUser.type=0;newUser.register=1;newUser.verify=true;newUser.save();res.json({code:200,msg:"ACCOUNT_CREATED"})}else res.json({code:401,msg:"BAD_LOCATION"})}else res.json({code:200,msg:"LOGIN_SUCCESS"})})});router.post("/auth/mobile/google",function(req,res){_UserModel.UserModel.find({email:(0,_cipher.encryptAES)((0,_cipher.decryptAndroid)(req.body.email))},function(err,docs){if(err)_logger.errorLog.error(err);if(docs.length==0){var newUser=new _UserModel.UserModel;var geo=[(0,_cipher.decryptAndroid)(req.body.lat),(0,_cipher.decryptAndroid)(req.body.lng)];if(geo){var userObject=newUser.encryptUser((0,_cipher.decryptAndroid)(req.body.email),geo[0],geo[1],(0,_cipher.decryptAndroid)(req.body.id));newUser.name=(0,_cipher.decryptAndroid)(req.body.name);newUser.lastName=(0,_cipher.decryptAndroid)(req.body.last_name);newUser.email=userObject.email;newUser.location.lat=userObject.lat;newUser.location.lng=userObject.lng;newUser.password=userObject.password;newUser.type=0;newUser.register=2;newUser.verify=true;newUser.save();res.json({code:200,msg:"ACCOUNT_CREATED"})}else res.json({code:401,msg:"BAD_LOCATION"})}else res.json({code:200,msg:"LOGIN_SUCCESS"})})});router.post("/auth/mobile/register",function(req,res,next){var language=req.acceptsLanguages("es","en");if(!language)language="en";req.body.email=(0,_cipher.encryptFromFront)((0,_cipher.decryptAndroid)(req.body.email));req.body.password=(0,_cipher.encryptFromFront)((0,_cipher.decryptAndroid)(req.body.password));req.body.name=(0,_cipher.encryptFromFront)((0,_cipher.decryptAndroid)(req.body.name));req.body.lastName=(0,_cipher.encryptFromFront)((0,_cipher.decryptAndroid)(req.body.lastName));_passport["default"].authenticate("local-signup",function(err,user,info){if(err)return res.json({code:401,msg:err});if(!user)return res.json({code:401,msg:["BAD_INPUT"]});(0,_email.sendEmail)((0,_cipher.decryptAES)(user.email),"verification",language,user.name+" "+user.lastName,user.type,user.email);req.logIn(user,function(err){if(err)return next(err);req.session.type=user.type;return res.json({code:200,msg:"SIGNUP_SUCCESS"})})})(req,res,next)});router.post("/auth/mobile/login",function(req,res,next){var language=req.acceptsLanguages("es","en");if(!language)language="en";req.body.email=(0,_cipher.encryptFromFront)((0,_cipher.decryptAndroid)(req.body.email));req.body.password=(0,_cipher.encryptFromFront)((0,_cipher.decryptAndroid)(req.body.password));_passport["default"].authenticate("local-signin",function(err,user,info){if(err)return res.send({code:401,msg:err});if(!user)return res.json({code:401,msg:["BAD_INPUT"]});req.logIn(user,function(err){if(err)return next({code:401,msg:err});req.session.type=user.type;res.cookie("auth",(0,_cipher.encryptAES)(JSON.stringify(user)));return res.json({code:200,msg:["LOGIN_SUCCESS"]})})})(req,res,next)});router.post("/auth/register",function(req,res,next){var language=req.acceptsLanguages("es","en");if(!language)language="en";_passport["default"].authenticate("local-signup",function(err,user,info){if(err)return res.json({code:401,msg:err});if(!user)return res.json({code:401,msg:["BAD_INPUT"]});(0,_email.sendEmail)((0,_cipher.decryptAES)(user.email),"verification",language,user.name+" "+user.lastName,user.type,user.email);req.logIn(user,function(err){if(err)return next(err);req.session.type=user.type;return res.json({code:200,msg:"SIGNUP_SUCCESS"})})})(req,res,next)});router.post("/auth/login",function(req,res,next){_passport["default"].authenticate("local-signin",function(err,user,info){if(err)return res.send({code:401,msg:err});if(!user)return res.json({code:401,msg:["BAD_INPUT"]});req.logIn(user,function(err){if(err)return next({code:401,msg:err});req.session.type=user.type;res.cookie("auth",(0,_cipher.encryptAES)(JSON.stringify(user)));return res.json({code:200,msg:["LOGIN_SUCCESS"]})})})(req,res,next)});router.get("/logout",function(req,res){req.session.destroy();req.logout();res.clearCookie("auth");res.redirect("/")});router.get("/mapRender",function(req,res){res.render("mapRender")});router.get("/mapMobile",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";res.render("MapMobile",{assets:JSON.parse(_fs["default"].readFileSync(_path["default"].join(__dirname,"../assets/"+language+".json"),"utf-8")),path:"/home",context:{location:{lat:(0,_cipher.encryptAES)(19..toString()),lng:(0,_cipher.encryptAES)((-99).toString())}},functions:{decryptAES:_cipher.decryptAES}})});router.get("/downloadAPK",function(req,res){res.download(_path["default"].join(__dirname,"../assets/Cyclon.apk"))});router.get("/twitterMobile",function(req,res){var language=req.acceptsLanguages("es","en");if(!language)language="en";res.render("TwitterMobile",{assets:JSON.parse(_fs["default"].readFileSync(_path["default"].join(__dirname,"../assets/"+language+".json"),"utf-8"))})});router.get("/keepAlive",function(req,res){res.send("Running")});module.exports=router;
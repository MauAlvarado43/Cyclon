{"version":3,"sources":["../../src/routes/unregister.js"],"names":["router","get","req","res","session","error","language","acceptsLanguages","user","redirect","assets","JSON","parse","fs","readFileSync","path","join","__dirname","render","title","titles","index","errors","privacy","terms","send","passport","authenticate","authType","scope","next","err","info","logIn","post","User","find","email","body","docs","errorLog","length","newUser","geo","geoip","lookup","ip","userObject","encryptUser","ll","id","name","lastName","location","lat","lng","password","type","verify","save","json","givenName","familyName","cookie","stringify","destroy","logout","clearCookie","module","exports"],"mappings":"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","file":"unregister.js","sourcesContent":["import {Router} from 'express'\r\nimport passport from 'passport'\r\nimport {UserModel as User} from '../models/UserModel'\r\nimport geoip from 'geoip-lite'\r\nimport path from 'path'\r\nimport fs from 'fs'\r\nimport { encryptFront, decryptFront, encryptAES, decryptAES, encryptAndroid, decryptAndroid } from '../utils/cipher'\r\nimport { errorLog } from '../utils/logger'\r\nimport { sendEmail } from '../utils/email'\r\n\r\nconst router = Router()\r\n\r\n/***************************************\r\n                Rendering\r\n***************************************/\r\n\r\nrouter.get('/', (req,res) => {\r\n    \r\n    if(!req.session.error)\r\n        req.session.error = []\r\n\r\n    let language = req.acceptsLanguages('es', 'en')\r\n    if (!language) language = 'en'\r\n    \r\n    if(req.user)\r\n        res.redirect('/home')\r\n    else{\r\n\r\n        let assets = JSON.parse(fs.readFileSync(path.join(__dirname,'../assets/'+language+'.json'),'utf-8'))\r\n\r\n        res.render('index', {\r\n            title: `Cyclon - ${assets.titles.index}`,\r\n            assets: assets, \r\n            path: '/',\r\n            errors: req.session.error\r\n        })\r\n    }\r\n    \r\n})\r\n\r\nrouter.get('/privacy', (req,res) => {\r\n    let language = req.acceptsLanguages('es', 'en')\r\n    if (!language) language = 'en'\r\n\r\n    let assets = JSON.parse(fs.readFileSync(path.join(__dirname,'../assets/'+language+'.json'),'utf-8'))\r\n\r\n    res.render('privacy', {\r\n        title: `Cyclon - ${assets.titles.privacy}`, \r\n        path: '/privacy',\r\n        assets: assets\r\n    })\r\n})\r\n\r\nrouter.get('/terms', (req,res) => {\r\n    let language = req.acceptsLanguages('es', 'en')\r\n    if (!language) language = 'en'\r\n\r\n    let assets = JSON.parse(fs.readFileSync(path.join(__dirname,'../assets/'+language+'.json'),'utf-8'))\r\n\r\n    res.render('terms', {\r\n        title: `Cyclon - ${assets.titles.terms}`, \r\n        path: '/terms',\r\n        assets: assets\r\n    })\r\n})\r\n\r\n/***************************************\r\n                    API\r\n***************************************/\r\n\r\nrouter.get('/assets', (req,res) => {\r\n    let language = req.acceptsLanguages('es', 'en')\r\n    if (!language) language = 'en'\r\n    res.send(JSON.parse(fs.readFileSync(path.join(__dirname,'../assets/'+language+'.json'),'utf-8')))\r\n})\r\n\r\n/***************************************\r\n          API Auth Navigator\r\n***************************************/\r\n\r\nrouter.get('/auth/facebook', passport.authenticate('facebook-auth', { authType: 'rerequest', scope:['email']}))\r\n\r\nrouter.get('/auth/facebook/callback', (req, res, next) => {\r\n    passport.authenticate('facebook-auth', function(err, user, info) {\r\n\r\n        if (err){\r\n            req.session.error = err \r\n            return res.redirect('/?action=login')\r\n        }\r\n        if (!user){ \r\n            req.session.error = ['BAD_INPUT']\r\n            return res.redirect('/?action=login') \r\n        }\r\n\r\n        req.logIn(user, function(err) {\r\n            if (err) return next({'code':401,'msg':err})\r\n            req.session.error = []\r\n            return res.redirect('/home') \r\n        })\r\n        \r\n    })(req, res, next)\r\n})\r\n\r\nrouter.get('/auth/google',passport.authenticate('google-auth', { scope: ['https://www.googleapis.com/auth/userinfo.profile','https://www.googleapis.com/auth/userinfo.email'] }))\r\n\r\nrouter.get('/auth/google/callback', (req, res, next) => {\r\n    passport.authenticate('google-auth', function(err, user, info) {\r\n        if (err){\r\n            req.session.error = err \r\n            return res.redirect('/?action=login')\r\n        }\r\n        if (!user){ \r\n            req.session.error = ['BAD_INPUT']\r\n            return res.redirect('/?action=login') \r\n        }\r\n\r\n        req.logIn(user, function(err) {\r\n            if (err) return next({'code':401,'msg':err})\r\n            req.session.error = []\r\n            return res.redirect('/home') \r\n        })\r\n        \r\n    })(req, res, next)\r\n})\r\n\r\n/***************************************\r\n     API Auth Navigator & Mobile\r\n***************************************/\r\n\r\nrouter.post('/auth/mobile/facebook', (req,res) => {\r\n\r\n    User.find({email: encryptAES(decryptAndroid(req.body.email))}, (err,docs) => {\r\n\r\n        if(err) errorLog.error(err)\r\n\r\n\t\tif(docs.length==0){\r\n            const newUser = new User()\r\n            \r\n            let geo = geoip.lookup(req.ip)\r\n\r\n            // geo = {\r\n            //     ll: [19, -99]\r\n            // }\r\n\t\t\t\r\n\t\t\tif(geo){\r\n\r\n\t\t\t\tlet userObject = newUser.encryptUser(\r\n\t\t\t\t\tdecryptAndroid(req.body.email),\r\n\t\t\t\t\tgeo.ll[0],\r\n\t\t\t\t\tgeo.ll[1],\r\n\t\t\t\t\tdecryptAndroid(req.body.id)\r\n\t\t\t\t)\r\n\t\t\t\r\n\t\t\t\tnewUser.name = decryptAndroid(req.body.name)\r\n\t\t\t\tnewUser.lastName = decryptAndroid(req.body.lastName)\r\n\t\t\t\tnewUser.email = userObject.email\r\n\t\t\t\tnewUser.location.lat = userObject.lat\r\n\t\t\t\tnewUser.location.lng = userObject.lng\r\n\t\t\t\tnewUser.password = userObject.password\r\n                newUser.type = 0\r\n                newUser.verify = true\r\n\t\t\t\r\n\t\t\t\tnewUser.save()\r\n\t\t\t\tres.json({'code': 200, 'msg': 'LOGIN_SUCCESS'})\r\n\t\t\t}\r\n\t\t\telse\r\n                res.json({'code': 401, 'msg': 'BAD_LOCATION'})\r\n\t\t\t    \t\t\r\n\t\t}\r\n\t\telse\r\n\t\t\tres.json({'code': 200, 'msg': 'LOGIN_SUCCESS'})\r\n\r\n\t})\r\n\r\n})\r\n\r\nrouter.post('/auth/mobile/google', (req,res) => {\r\n\r\n    User.find({email: encryptAES(decryptAndroid(req.body.email))}, (err,docs) => {\r\n\r\n        if(err) errorLog.error(err)\r\n\r\n\t\tif(docs.length==0){\r\n\t\t\tconst newUser = new User()\r\n\r\n\t\t\tlet geo = geoip.lookup(req.ip)\r\n\t\t\t\r\n\t\t\tif(geo){\r\n\r\n\t\t\t\tlet userObject = newUser.encryptUser(\r\n\t\t\t\t\tdecryptAndroid(req.body.email),\r\n\t\t\t\t\tgeo.ll[0],\r\n\t\t\t\t\tgeo.ll[1],\r\n\t\t\t\t\tdecryptAndroid(req.body.id)\r\n\t\t\t\t)\r\n\t\t\t\r\n\t\t\t\tnewUser.name = decryptAndroid(req.body.givenName)\r\n\t\t\t\tnewUser.lastName = decryptAndroid(req.body.familyName)\r\n\t\t\t\tnewUser.email = userObject.email\r\n\t\t\t\tnewUser.location.lat = userObject.lat\r\n\t\t\t\tnewUser.location.lng = userObject.lng\r\n\t\t\t\tnewUser.password = userObject.password\r\n\t\t\t\tnewUser.type = 0\r\n                newUser.verify = true\r\n                \r\n\t\t\t\tnewUser.save()\r\n                \r\n                res.json({'code':200,'msg':['ACCOUNT_CREATED']})\r\n                \r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t\tres.json({'code':401,'msg':['BAD_LOCATION']})\r\n\t\t\t     \t\t\r\n\t\t}\r\n\t\telse\r\n\t\t\tres.json({'code':200,'msg':['LOGIN_SUCCESS']})\r\n\t\t\r\n\r\n\t})\r\n\r\n})\r\n\r\nrouter.post('/auth/register', (req, res, next) => {\r\n\r\n    let language = req.acceptsLanguages('es', 'en')\r\n    if (!language) language = 'en' \r\n\r\n    passport.authenticate('local-signup', function(err, user, info) {\r\n        \r\n        if (err)\r\n            return res.json({'code':401,'msg':err})\r\n        \r\n        if (!user)\r\n            return res.json({'code':401,'msg':['BAD_INPUT']})\r\n        \r\n\r\n        sendEmail(decryptAES(user.email), 'verification', language, user.name + ' ' + user.lastName, user.type, user.email)\r\n\r\n        req.logIn(user, function(err) {\r\n            if (err) return next(err)\r\n            return res.json({'code':200,'msg':'SIGNUP_SUCCESS'})\r\n        })\r\n\r\n    })(req, res, next)\r\n})\r\n\r\nrouter.post('/auth/login', (req,res,next) => {\r\n    passport.authenticate('local-signin', function(err, user, info) {\r\n        if (err)  return res.send({'code':401,'msg':err})\r\n        if (!user) return res.json({'code':401,'msg':['BAD_INPUT']})\r\n\r\n        req.logIn(user, function(err) {\r\n          if (err) return next({'code':401,'msg':err})\r\n          res.cookie('auth', encryptAES(JSON.stringify(user)))\r\n          return res.json({'code':200,'msg':['LOGIN_SUCCESS']})\r\n        })\r\n    })(req, res, next)\r\n})\r\n\r\nrouter.get('/logout', function(req, res){\r\n    req.session.destroy()\r\n    req.logout()\r\n    res.clearCookie('auth')\r\n    res.redirect('/')\r\n})\r\n\r\nmodule.exports = router"]}
{"version":3,"file":"facebook-auth.js","names":["passport","use","FacebookStrategy","clientID","clientSecret","callbackURL","process","env","URL","passReqToCallback","profileFields","req","accessToken","refreshToken","profile","done","console","log","clientIp","User","find","email","encryptAES","emails","value","err","docs","errorLog","error","length","newUser","geo","geoip","lookup","userObject","encryptUser","ll","id","name","givenName","lastName","familyName","location","lat","lng","password","type","verify","register","dateRegister","Date","save"],"sources":["../../src/passport/facebook-auth.js"],"sourcesContent":["import passport from 'passport'\r\nimport {Strategy as FacebookStrategy } from 'passport-facebook'\r\nimport {UserModel as User} from '../models/UserModel'\r\nimport geoip from 'geoip-lite'\r\nimport {encryptAES} from '../utils/cipher'\r\nimport { errorLog } from '../utils/logger'\r\n\r\npassport.use('facebook-auth',new FacebookStrategy({\r\n    clientID: '3170951326462560',\r\n    clientSecret: 'e201c5704c07e7b3bcdc9f79a890feb2',\r\n    callbackURL: process.env.URL + '/auth/facebook/callback',\r\n    passReqToCallback: true,\r\n    profileFields: ['id', 'email', 'first_name', 'last_name']\r\n}, async (req, accessToken, refreshToken, profile, done) => {\r\n\r\n\tconsole.log(req.clientIp)\r\n\r\n\r\n    User.find({email: encryptAES(profile.emails[0].value)}, async (err,docs) => {\r\n\r\n\t\tif(err) errorLog.error(err)\r\n\r\n\t\tif(docs.length==0){\r\n\r\n\t\t\tconst newUser = new User()\r\n\r\n\t\t\tlet geo = geoip.lookup(req.clientIp)\r\n\t\t\t\r\n\t\t\tif(geo){\r\n\r\n\t\t\t\tlet userObject = newUser.encryptUser(\r\n\t\t\t\t\tprofile.emails[0].value,\r\n\t\t\t\t\tgeo.ll[0],\r\n\t\t\t\t\tgeo.ll[1],\r\n\t\t\t\t\tprofile.id\r\n\t\t\t\t)\r\n\t\t\t\r\n\t\t\t\tnewUser.name = profile.name.givenName\r\n\t\t\t\tnewUser.lastName = profile.name.familyName\r\n\t\t\t\tnewUser.email = userObject.email\r\n\t\t\t\tnewUser.location.lat = userObject.lat\r\n\t\t\t\tnewUser.location.lng = userObject.lng\r\n\t\t\t\tnewUser.password = userObject.password\r\n\t\t\t\tnewUser.type = 0\r\n\t\t\t\tnewUser.verify = true\r\n\t\t\t\tnewUser.register = 1\r\n\t\t\t\tnewUser.dateRegister = new Date()\r\n\t\t\t\t\t\t\t\r\n\t\t\t\tawait newUser.save()\r\n\t\t\t\tdone(null, newUser)\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\treturn done(['BAD_LOCATION'], false)\r\n\t\t\t}     \t\t\r\n\t\t}\r\n\t\telse{\r\n\t\t\tdone(null, docs[0])\r\n\t\t}\r\n\r\n\t})\r\n\r\n  }\r\n))"],"mappings":";;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;+CAJA,oJ;;;;;;AAMAA,oBAAA,CAASC,GAAT,CAAa,eAAb,EAA6B,IAAIC,0BAAJ,CAAqB;EAC9CC,QAAQ,EAAE,kBADoC;EAE9CC,YAAY,EAAE,kCAFgC;EAG9CC,WAAW,EAAEC,OAAO,CAACC,GAAR,CAAYC,GAAZ,GAAkB,yBAHe;EAI9CC,iBAAiB,EAAE,IAJ2B;EAK9CC,aAAa,EAAE,CAAC,IAAD,EAAO,OAAP,EAAgB,YAAhB,EAA8B,WAA9B;AAL+B,CAArB;EAAA,sEAM1B,kBAAOC,GAAP,EAAYC,WAAZ,EAAyBC,YAAzB,EAAuCC,OAAvC,EAAgDC,IAAhD;IAAA;MAAA;QAAA;UAAA;YAEFC,OAAO,CAACC,GAAR,CAAYN,GAAG,CAACO,QAAhB;;YAGGC,oBAAA,CAAKC,IAAL,CAAU;cAACC,KAAK,EAAE,IAAAC,kBAAA,EAAWR,OAAO,CAACS,MAAR,CAAe,CAAf,EAAkBC,KAA7B;YAAR,CAAV;cAAA,uEAAwD,iBAAOC,GAAP,EAAWC,IAAX;gBAAA;gBAAA;kBAAA;oBAAA;sBAAA;wBAE1D,IAAGD,GAAH,EAAQE,gBAAA,CAASC,KAAT,CAAeH,GAAf;;wBAFkD,MAIvDC,IAAI,CAACG,MAAL,IAAa,CAJ0C;0BAAA;0BAAA;wBAAA;;wBAMnDC,OANmD,GAMzC,IAAIX,oBAAJ,EANyC;wBAQrDY,GARqD,GAQ/CC,qBAAA,CAAMC,MAAN,CAAatB,GAAG,CAACO,QAAjB,CAR+C;;wBAAA,KAUtDa,GAVsD;0BAAA;0BAAA;wBAAA;;wBAYpDG,UAZoD,GAYvCJ,OAAO,CAACK,WAAR,CAChBrB,OAAO,CAACS,MAAR,CAAe,CAAf,EAAkBC,KADF,EAEhBO,GAAG,CAACK,EAAJ,CAAO,CAAP,CAFgB,EAGhBL,GAAG,CAACK,EAAJ,CAAO,CAAP,CAHgB,EAIhBtB,OAAO,CAACuB,EAJQ,CAZuC;wBAmBxDP,OAAO,CAACQ,IAAR,GAAexB,OAAO,CAACwB,IAAR,CAAaC,SAA5B;wBACAT,OAAO,CAACU,QAAR,GAAmB1B,OAAO,CAACwB,IAAR,CAAaG,UAAhC;wBACAX,OAAO,CAACT,KAAR,GAAgBa,UAAU,CAACb,KAA3B;wBACAS,OAAO,CAACY,QAAR,CAAiBC,GAAjB,GAAuBT,UAAU,CAACS,GAAlC;wBACAb,OAAO,CAACY,QAAR,CAAiBE,GAAjB,GAAuBV,UAAU,CAACU,GAAlC;wBACAd,OAAO,CAACe,QAAR,GAAmBX,UAAU,CAACW,QAA9B;wBACAf,OAAO,CAACgB,IAAR,GAAe,CAAf;wBACAhB,OAAO,CAACiB,MAAR,GAAiB,IAAjB;wBACAjB,OAAO,CAACkB,QAAR,GAAmB,CAAnB;wBACAlB,OAAO,CAACmB,YAAR,GAAuB,IAAIC,IAAJ,EAAvB;wBA5BwD;wBAAA,OA8BlDpB,OAAO,CAACqB,IAAR,EA9BkD;;sBAAA;wBA+BxDpC,IAAI,CAAC,IAAD,EAAOe,OAAP,CAAJ;wBA/BwD;wBAAA;;sBAAA;wBAAA,iCAkCjDf,IAAI,CAAC,CAAC,cAAD,CAAD,EAAmB,KAAnB,CAlC6C;;sBAAA;wBAAA;wBAAA;;sBAAA;wBAsCzDA,IAAI,CAAC,IAAD,EAAOW,IAAI,CAAC,CAAD,CAAX,CAAJ;;sBAtCyD;sBAAA;wBAAA;oBAAA;kBAAA;gBAAA;cAAA,CAAxD;;cAAA;gBAAA;cAAA;YAAA;;UALD;UAAA;YAAA;QAAA;MAAA;IAAA;EAAA,CAN0B;;EAAA;IAAA;EAAA;AAAA,IAA7B"}
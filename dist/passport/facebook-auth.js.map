{"version":3,"sources":["../../src/passport/facebook-auth.js"],"names":["passport","use","FacebookStrategy","clientID","clientSecret","callbackURL","process","env","URL","passReqToCallback","profileFields","req","accessToken","refreshToken","profile","done","User","find","email","emails","value","err","docs","errorLog","error","length","newUser","geo","geoip","lookup","ip","ll","userObject","encryptUser","id","name","givenName","lastName","familyName","location","lat","lng","password","type","verify","save"],"mappings":";;AAAA;;;;AACA;;AACA;;AACA;;;;AACA;;AACA;;;;;;AAEAA,mBAASC,GAAT,CAAa,eAAb,EAA6B,IAAIC,0BAAJ,CAAqB;AAC9CC,WAAU,kBADoC;AAE9CC,eAAc,kCAFgC;AAG9CC,cAAaC,QAAQC,GAAR,CAAYC,GAAZ,GAAkB,yBAHe;AAI9CC,oBAAmB,IAJ2B;AAK9CC,gBAAe,CAAC,IAAD,EAAO,OAAP,EAAgB,YAAhB,EAA8B,WAA9B;AAL+B,CAArB;AAAA,oEAMzB,iBAAOC,GAAP,EAAYC,WAAZ,EAAyBC,YAAzB,EAAuCC,OAAvC,EAAgDC,IAAhD;AAAA;AAAA;AAAA;AAAA;;AAEAC,2BAAKC,IAAL,CAAU,EAACC,OAAO,wBAAWJ,QAAQK,MAAR,CAAe,CAAf,EAAkBC,KAA7B,CAAR,EAAV,EAAwD,UAACC,GAAD,EAAKC,IAAL,EAAc;;AAExE,WAAGD,GAAH,EAAQE,iBAASC,KAAT,CAAeH,GAAf;;AAER,WAAGC,KAAKG,MAAL,IAAa,CAAhB,EAAkB;AACjB,YAAMC,UAAU,IAAIV,oBAAJ,EAAhB;;AAEA,YAAIW,MAAMC,oBAAMC,MAAN,CAAalB,IAAImB,EAAjB,CAAV;;AAEAH,cAAM;AACOI,aAAI,CAAC,EAAD,EAAK,CAAC,EAAN;AADX,SAAN;;AAIA,YAAGJ,GAAH,EAAO;;AAEN,aAAIK,aAAaN,QAAQO,WAAR,CAChBnB,QAAQK,MAAR,CAAe,CAAf,EAAkBC,KADF,EAEhBO,IAAII,EAAJ,CAAO,CAAP,CAFgB,EAGhBJ,IAAII,EAAJ,CAAO,CAAP,CAHgB,EAIhBjB,QAAQoB,EAJQ,CAAjB;;AAOAR,iBAAQS,IAAR,GAAerB,QAAQqB,IAAR,CAAaC,SAA5B;AACAV,iBAAQW,QAAR,GAAmBvB,QAAQqB,IAAR,CAAaG,UAAhC;AACAZ,iBAAQR,KAAR,GAAgBc,WAAWd,KAA3B;AACAQ,iBAAQa,QAAR,CAAiBC,GAAjB,GAAuBR,WAAWQ,GAAlC;AACAd,iBAAQa,QAAR,CAAiBE,GAAjB,GAAuBT,WAAWS,GAAlC;AACAf,iBAAQgB,QAAR,GAAmBV,WAAWU,QAA9B;AACAhB,iBAAQiB,IAAR,GAAe,CAAf;AACAjB,iBAAQkB,MAAR,GAAiB,IAAjB;;AAEAlB,iBAAQmB,IAAR;AACA9B,cAAK,IAAL,EAAWW,OAAX;AACA,SApBD,MAqBI;AACH,gBAAOX,KAAK,CAAC,cAAD,CAAL,EAAuB,KAAvB,CAAP;AACA;AACD,QAjCD,MAkCI;AACHA,aAAK,IAAL,EAAWO,KAAK,CAAL,CAAX;AACA;AAED,OA1CE;;AAFA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EANyB;;AAAA;AAAA;AAAA;AAAA,IAA7B","file":"facebook-auth.js","sourcesContent":["import passport from 'passport'\r\nimport {Strategy as FacebookStrategy } from 'passport-facebook'\r\nimport {UserModel as User} from '../models/UserModel'\r\nimport geoip from 'geoip-lite'\r\nimport {encryptAES} from '../utils/cipher'\r\nimport { errorLog } from '../utils/logger'\r\n\r\npassport.use('facebook-auth',new FacebookStrategy({\r\n    clientID: '3170951326462560',\r\n    clientSecret: 'e201c5704c07e7b3bcdc9f79a890feb2',\r\n    callbackURL: process.env.URL + '/auth/facebook/callback',\r\n    passReqToCallback: true,\r\n    profileFields: ['id', 'email', 'first_name', 'last_name']\r\n  },async (req, accessToken, refreshToken, profile, done) => {\r\n\r\n    User.find({email: encryptAES(profile.emails[0].value)}, (err,docs) => {\r\n\r\n\t\tif(err) errorLog.error(err)\r\n\r\n\t\tif(docs.length==0){\r\n\t\t\tconst newUser = new User()\r\n\r\n\t\t\tlet geo = geoip.lookup(req.ip)\r\n\r\n\t\t\tgeo = {\r\n                ll: [19, -99]\r\n            }\r\n\t\t\t\r\n\t\t\tif(geo){\r\n\r\n\t\t\t\tlet userObject = newUser.encryptUser(\r\n\t\t\t\t\tprofile.emails[0].value,\r\n\t\t\t\t\tgeo.ll[0],\r\n\t\t\t\t\tgeo.ll[1],\r\n\t\t\t\t\tprofile.id\r\n\t\t\t\t)\r\n\t\t\t\r\n\t\t\t\tnewUser.name = profile.name.givenName\r\n\t\t\t\tnewUser.lastName = profile.name.familyName\r\n\t\t\t\tnewUser.email = userObject.email\r\n\t\t\t\tnewUser.location.lat = userObject.lat\r\n\t\t\t\tnewUser.location.lng = userObject.lng\r\n\t\t\t\tnewUser.password = userObject.password\r\n\t\t\t\tnewUser.type = 0\r\n\t\t\t\tnewUser.verify = true\r\n\t\t\t\t\t\t\t\r\n\t\t\t\tnewUser.save()\r\n\t\t\t\tdone(null, newUser)\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\treturn done(['BAD_LOCATION'], false)\r\n\t\t\t}     \t\t\r\n\t\t}\r\n\t\telse{\r\n\t\t\tdone(null, docs[0])\r\n\t\t}\r\n\r\n\t})\r\n\r\n  }\r\n))"]}
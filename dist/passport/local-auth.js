"use strict";var _passport=require("passport");var _passport2=_interopRequireDefault(_passport);var _passportLocal=require("passport-local");var _geoipLite=require("geoip-lite");var _geoipLite2=_interopRequireDefault(_geoipLite);var _UserModel=require("../models/UserModel");var _cipher=require("../utils/cipher");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step("next",value)},function(err){step("throw",err)})}}return step("next")})}}_passport2.default.serializeUser(function(user,done){done(null,user.id)});_passport2.default.deserializeUser(function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(id,done){var user;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return _UserModel.UserModel.findById(id);case 2:user=_context.sent;done(null,user);case 4:case"end":return _context.stop()}}},_callee,undefined)}));return function(_x,_x2){return _ref.apply(this,arguments)}}());_passport2.default.use("local-signup",new _passportLocal.Strategy({usernameField:"email",passwordField:"password",passReqToCallback:true},function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(req,emailCrypted,passwordCrypted,done){var email,password,user,newUser,userValidation,geo,userObject;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:email=(0,_cipher.decryptFront)(emailCrypted);password=(0,_cipher.decryptFront)(passwordCrypted);_context2.next=4;return _UserModel.UserModel.findOne({email:(0,_cipher.encryptAES)(email)});case 4:user=_context2.sent;if(!user){_context2.next=9;break}return _context2.abrupt("return",done(["EMAIL_TAKEN"],false));case 9:newUser=new _UserModel.UserModel;userValidation=newUser.validateUser((0,_cipher.decryptFront)(req.body.name),(0,_cipher.decryptFront)(req.body.lastName),email,password);if(!(userValidation.length==0)){_context2.next=31;break}geo=_geoipLite2.default.lookup(req.ip);if(!geo){_context2.next=28;break}userObject=newUser.encryptUser(email,geo.ll[0],geo.ll[1],password);newUser.name=(0,_cipher.decryptFront)(req.body.name);newUser.lastName=(0,_cipher.decryptFront)(req.body.lastName);newUser.email=userObject.email;newUser.location.lat=userObject.lat;newUser.location.lng=userObject.lng;newUser.password=userObject.password;newUser.type=0;newUser.verify=false;_context2.next=25;return newUser.save();case 25:done(null,newUser);_context2.next=29;break;case 28:return _context2.abrupt("return",done(["BAD_LOCATION"],false));case 29:_context2.next=32;break;case 31:return _context2.abrupt("return",done(userValidation,false));case 32:case"end":return _context2.stop()}}},_callee2,undefined)}));return function(_x3,_x4,_x5,_x6){return _ref2.apply(this,arguments)}}()));_passport2.default.use("local-signin",new _passportLocal.Strategy({usernameField:"email",passwordField:"password",passReqToCallback:true},function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(req,email,password,done){var user;return regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return _UserModel.UserModel.findOne({email:(0,_cipher.encryptAES)((0,_cipher.decryptFront)(email))});case 2:user=_context3.sent;if(user){_context3.next=5;break}return _context3.abrupt("return",done(["USER_NOT_EXIST"],false));case 5:if(user.comparePassword((0,_cipher.encryptAES)((0,_cipher.decryptFront)(password)),user.password)){_context3.next=7;break}return _context3.abrupt("return",done(["INCORRECT_PASSWORD"],false));case 7:return _context3.abrupt("return",done(null,user));case 8:case"end":return _context3.stop()}}},_callee3,undefined)}));return function(_x7,_x8,_x9,_x10){return _ref3.apply(this,arguments)}}()));
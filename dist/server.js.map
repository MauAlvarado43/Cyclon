{"version":3,"file":"server.js","names":["app","express","server","http","createServer","store","memoryStore","session","corsOptions","origin","limiter","rateLimit","windowMs","max","message","require","config","use","name","secret","resave","saveUninitialized","expires","req","res","next","user","cookies","logIn","decryptAES","JSON","parse","err","graphqlHTTP","graphiql","schema","context","set","process","env","PORT","helmet","compression","bodyParser","urlencoded","extended","json","cookieParser","passport","initialize","morgan","infoLog","stream","cors","path","join","__dirname","flash","requestIP","mw","cyclonSocket","listen","get","console","log","setInterval","fetch","PYTHON_URL","then","text","reject","URL"],"sources":["../src/server.js"],"sourcesContent":["import express from 'express'\r\nimport http from 'http'\r\nimport compression from 'compression'\r\nimport session from 'express-session'\r\nimport rateLimit from 'express-rate-limit'\r\nimport helmet from 'helmet'\r\nimport bodyParser from 'body-parser'\r\nimport cookieParser from 'cookie-parser'\r\nimport memoryStore from 'session-memory-store'\r\nimport cors from 'cors'\r\nimport passport from 'passport'\r\nimport morgan from 'morgan'\r\nimport flash from 'connect-flash'\r\nimport path from 'path'\r\nimport graphqlHTTP from 'express-graphql'\r\nimport schema from './config/schema'\r\nimport { infoLog } from './utils/logger'\r\nimport { decryptAES } from './utils/cipher'\r\nimport requestIP from 'request-ip'\r\nimport fetch from 'node-fetch'\r\n\r\n// Initialzing packages\r\nconst app = express()\r\nconst server = http.createServer(app)\r\nconst store = memoryStore(session)\r\nconst corsOptions = {\r\n    origin: '*'\r\n}\r\nconst limiter = rateLimit({\r\n    windowMs: 15 * 60 * 1000,\r\n    max: 1000,\r\n    message: \"DDOS detected\"\r\n})\r\n\r\nrequire('dotenv').config()\r\nrequire('./config/database')\r\nrequire('./passport/local-auth')\r\nrequire('./passport/google-auth')\r\nrequire('./passport/facebook-auth')\r\n\r\n// Middlewares\r\napp.use(session({\r\n    name: 'JSESSION',\r\n    secret: 'secret',\r\n    resave: true,\r\n    saveUninitialized: true,\r\n    store: new store({\r\n        expires: 60 * 60 * 12\r\n    })\r\n}))\r\n\r\napp.use('*', (req,res,next) => {\r\n    if(!req.user && req.cookies && req.cookies.user){\r\n        req.logIn(decryptAES(JSON.parse(req.cookies.user)), function(err) {\r\n            next()\r\n        })\r\n    }\r\n    else next()\r\n})\r\n\r\napp.use('/graphql', (req,res,next) => { \r\n    graphqlHTTP({\r\n            graphiql: false,\r\n            schema: schema,\r\n            context: req.session\r\n        })(req, res, next)\r\n    }\r\n)\r\n\r\napp.use((req, res, next) => {\r\n    res.set('Cache-Control', 'no-store')\r\n    next()\r\n})\r\n\r\n// Settings\r\napp.set('port', process.env.PORT || 3000)\r\napp.use(helmet())\r\napp.use(compression())\r\napp.use(bodyParser.urlencoded({ extended: true }))\r\napp.use(bodyParser.json())\r\napp.use(cookieParser('secret'))\r\napp.use(passport.initialize())\r\napp.use(passport.session())\r\napp.use(morgan('combined', { 'stream': infoLog.stream }))\r\napp.use(cors(corsOptions))\r\napp.use(express.static(path.join(__dirname, 'public')))\r\napp.use(flash())\r\napp.use(requestIP.mw())\r\napp.use(limiter)\r\napp.set('view engine','ejs')\r\napp.set('views','src/views')\r\napp.use('/graphql',  passport.initialize())\r\napp.use('/graphql',  passport.session())\r\n\r\n//Routes\r\napp.use(require('./routes/unregister'))\r\napp.use(require('./routes/register'))\r\napp.use(require('./routes/admin')(server))\r\napp.use(require('./routes/investigator'))\r\n\r\nconst cyclonSocket = require(\"./config/socket\")(server)\r\n\r\n// Start the server\r\nserver.listen(app.get('port'),'0.0.0.0', () => {\r\n    console.log('Server on port', app.get('port'))\r\n})\r\n\r\nsetInterval(() => {\r\n    fetch(process.env.PYTHON_URL).then( res => { res.text().then( text => { console.log(\"Socket found\") }) }).catch(reject => console.log(\"Socket not found\"))\r\n    fetch(process.env.URL + '/keepAlive').then( res => { res.text().then( text => { console.log(\"Server found\") }) }).catch(reject => console.log(\"Server not found\"))\r\n}, 2000 * 60)\r\n\r\nexport default server"],"mappings":"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"}